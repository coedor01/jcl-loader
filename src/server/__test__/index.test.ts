import { loadRaw, createParser, createParserWithLruCache, getGameBasePlayers } from "..";
import { EventType, LuaDataType } from "../typed";


describe("load module", () => {
  test("load function", () => {
    expect(
      loadRaw("638309433	4388291	1716702578	200309	21	{536944023,536944023,0,1,755,1,false,2,{[13]=0,[14]=0}}")[0].crc
    ).toBe(638309433);
  });

  test("parser function", () => {
    expect(
      createParser(
        loadRaw("638309433	4388291	1716702578	200309	21	{536944023,536944023,0,1,755,1,false,2,{[13]=0,[14]=0}}\n638309433	4388291	1716702578	200309	30	{536944023,536944023,0,1,755,1,false,2,{[13]=0,[14]=0}}")
      )<LuaDataType.SysMsgUiOmeSkillEffectLog>(
        EventType.SysMsgUiOmeSkillEffectLog,
      )[0].luadata.dwCaster
    ).toBe(536944023);
  });
  test("parser function with lru cache", () => {
    expect(
      createParserWithLruCache(
        loadRaw("638309433	4388291	1716702578	200309	21	{536944023,536944023,0,1,755,1,false,2,{[13]=0,[14]=0}}"),
        10
      )<LuaDataType.SysMsgUiOmeSkillEffectLog>(
        EventType.SysMsgUiOmeSkillEffectLog,
      )[0].luadata.dwCaster
    ).toBe(536944023);
  });
  test("get game base players", async () => {
    expect(
      await getGameBasePlayers(
        createParserWithLruCache(
          loadRaw('3896127656	4388407	1716702585	207574	4	{536944023,"六边形牛马·乾坤一掷",3,10026,239619,{{2,6,34021,6,{{5,24445}},0,0,0},{3,7,99995,6,{},0,0,0},{4,7,93620,6,{{5,24445},{5,24445}},0,0,0},{5,8,39951,6,{},0,0,0},{6,8,40081,6,{},0,0,0},{7,8,40665,6,{},0,0,0},{8,7,99911,6,{},0,0,0},{9,8,40055,6,{},0,0,0},{10,7,93259,6,{},0,0,0},{11,7,99451,6,{},0,0,0},{12,7,99399,6,{},0,0,0},{13,8,94,0,{},0,0,0},{14,8,69,0,{},0,0,0},{15,8,69,0,{},0,0,0},{16,8,3958,0,{},0,0,0},{17,8,95,0,{},0,0,0},{18,8,28,0,{},0,0,0},{19,8,28,0,{},0,0,0},{20,8,28,0,{},0,0,0},{21,8,4023,0,{},0,0,0},{22,8,28,0,{},0,0,0},{24,8,22527,0,{},0,0,0},{25,8,22526,0,{},0,0,0},{26,8,22528,0,{},0,0,0},{0,6,36954,7,{},0,0,0}},{{3,18487,1},{3,18224,1},{3,5659,1},{1,18226,1},{3,14824,1},{4,6530,1},{4,2611,1},{4,6781,1},{4,2628,1},{5,24899,1},{1,14821,1},{3,30654,1}},"270215977655399648",{}}'),
          10
        )
      )
    )
  });
});